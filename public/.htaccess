RewriteEngine On

# Serve existing files and directories directly
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Block hidden files (e.g., .git, .env if placed under public by mistake)
RewriteRule "(^|/)\." - [F]

# Route everything else to index.php
RewriteRule ^ index.php [QSA,L]

# Security hardening
Options -Indexes
FileETag None
ServerSignature Off
AddDefaultCharset utf-8

# Block direct access to sensitive files if placed in public by mistake
<FilesMatch "(^\.env|composer\.(json|lock)|package\.json|package-lock\.json|yarn\.lock|pnpm-lock\.yaml|phpunit\.xml|database\.(sql|sqlite)|\.git|\.svn|\.hg)">
  Require all denied
</FilesMatch>

# MIME types (ensure correct content types)
AddType image/svg+xml .svg .svgz
AddEncoding gzip .svgz
AddType image/webp .webp
AddType font/woff2 .woff2

# Compression (Brotli then Deflate)
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>

# Caching for static assets
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/css "access plus 7 days"
  ExpiresByType application/javascript "access plus 7 days"
  ExpiresByType text/javascript "access plus 7 days"
  ExpiresByType image/svg+xml "access plus 30 days"
  ExpiresByType image/webp "access plus 30 days"
  ExpiresByType image/x-icon "access plus 30 days"
  ExpiresByType image/jpeg "access plus 30 days"
  ExpiresByType image/png "access plus 30 days"
  ExpiresByType image/gif "access plus 30 days"
  ExpiresByType font/woff2 "access plus 30 days"
  ExpiresDefault "access plus 1 day"
</IfModule>
<IfModule mod_headers.c>
  <FilesMatch "\.(css|js)$">
    Header set Cache-Control "public, max-age=604800, immutable"
  </FilesMatch>
  <FilesMatch "\.(svg|webp|png|jpe?g|gif|ico|woff2)$">
    Header set Cache-Control "public, max-age=2592000, immutable"
  </FilesMatch>
</IfModule>

# Fallback security headers (primary set in PHP)
<IfModule mod_headers.c>
  Header setifempty X-Frame-Options "SAMEORIGIN"
  Header setifempty X-Content-Type-Options "nosniff"
  Header setifempty Referrer-Policy "no-referrer-when-downgrade"
  Header setifempty Permissions-Policy "geolocation=(), microphone=(), camera=()"
  Header unset X-Powered-By
</IfModule>

# NOTE: HSTS should be enabled only on HTTPS vhost
# <IfModule mod_headers.c>
#   Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
# </IfModule>